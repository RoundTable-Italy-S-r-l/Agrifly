// ============================================================================
// DJI AGRAS E-COMMERCE SCHEMA - PostgreSQL
// ============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// BASE MODELS (from existing schema)
// ============================================================================

model User {
  id                  String         @id @default(cuid()) @map("id")
  email               String         @unique @map("email")
  phone               String?        @map("phone")
  first_name          String         @map("first_name")
  last_name           String         @map("last_name")
  password_salt       String?        @map("password_salt")
  password_hash       String?        @map("password_hash")
  email_verified      Boolean        @default(false) @map("email_verified")
  email_verified_at   DateTime?      @map("email_verified_at")
  oauth_provider      OAuthProvider? @map("oauth_provider")
  oauth_id            String?        @map("oauth_id")
  reset_token         String?        @map("reset_token")
  reset_token_expires DateTime?      @map("reset_token_expires")
  status              UserStatus     @default(ACTIVE) @map("status")
  created_at          DateTime       @default(now()) @map("created_at")
  updated_at          DateTime       @updatedAt @map("updated_at")

  // Relations
  org_memberships               OrgMembership[]
  operator_profiles             OperatorProfile[]
  external_calendar_connections ExternalCalendarConnection[]
  verification_codes            VerificationCode[]
  organization_invitations      OrganizationInvitation[]
  notification_preferences      UserNotificationPreferences?
  messages                      Message[]
  shopping_carts                ShoppingCart[]

  @@unique([oauth_provider, oauth_id])
  @@map("users")
}

enum OAuthProvider {
  GOOGLE
  FACEBOOK
  APPLE
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

model Organization {
  id                        String                    @id @default(cuid()) @map("id")
  legal_name                String                    @map("legal_name")
  logo_url                  String?                   @map("logo_url")
  phone                     String?                   @map("phone")
  support_email             String?                   @map("support_email")
  vat_number                String?                   @map("vat_number")
  tax_code                  String?                   @map("tax_code")
  kind                      String                    @default("BUSINESS") @map("kind")
  can_buy                   Boolean                   @default(true) @map("can_buy")
  can_sell                  Boolean                   @default(false) @map("can_sell")
  can_operate               Boolean                   @default(false) @map("can_operate")
  can_dispatch              Boolean                   @default(false) @map("can_dispatch")
  address_line              String                    @map("address_line")
  city                      String                    @map("city")
  province                  String                    @map("province")
  region                    String                    @map("region")
  postal_code               String?                   @map("postal_code")
  country                   String                    @default("IT") @map("country")
  status                    String                    @default("ACTIVE") @map("status")
  created_at                DateTime                  @default(now()) @map("created_at")
  updated_at                DateTime                  @updatedAt @map("updated_at")

  // E-commerce relations
  shopping_carts             ShoppingCart[]
  wishlist_items             WishlistItem[]
  orders_buyer               Order[]                  @relation("BuyerOrder")
  orders_seller              Order[]                  @relation("SellerOrder")

  // Existing relations
  org_memberships           OrgMembership[]
  org_payment_accounts      OrgPaymentAccount?
  organization_invitations  OrganizationInvitation[]
  rate_cards                RateCard[]
  saved_fields              SavedField[]
  service_configuration     ServiceConfiguration?
  conversation_participants ConversationParticipant[]
  job_offers_operator       JobOffer[]                @relation("OperatorOffer")
  jobs_broker               Job[]                     @relation("BrokerJob")
  jobs_buyer                Job[]                     @relation("BuyerJob")
  operator_profiles         OperatorProfile[]
  bookings_executor         Booking[]                 @relation("ExecutorBooking")
  bookings_broker           Booking[]                 @relation("BrokerBooking")
  bookings_buyer            Booking[]                 @relation("BuyerBooking")

  @@map("organizations")
}

model OrgMembership {
  id         String       @id @default(cuid()) @map("id")
  org_id     String       @map("org_id")
  user_id    String       @map("user_id")
  role       String       @default("BUYER") @map("role")
  is_active  Boolean      @default(true) @map("is_active")
  created_at DateTime     @default(now()) @map("created_at")

  user       User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  org        Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([org_id, user_id])
  @@map("org_memberships")
}

// ============================================================================
// PRODUCTS & CATALOG
// ============================================================================

model Product {
  id                String          @id @default(cuid()) @map("id")
  name              String          @map("name")
  model             String          @map("model")
  brand             String          @map("brand")
  product_type      String          @map("product_type")
  specs_json        Json?           @map("specs_json")
  specs_core_json   Json?           @map("specs_core_json")
  specs_extra_json  Json?           @map("specs_extra_json")
  images_json       Json?           @map("images_json")
  glb_files_json    Json?           @map("glb_files_json")
  manuals_pdf_json  Json?           @map("manuals_pdf_json")
  status            String          @default("ACTIVE") @map("status")
  created_at        DateTime        @default(now()) @map("created_at")
  updated_at        DateTime        @updatedAt @map("updated_at")

  skus              Sku[]

  @@map("products")
}

model Sku {
  id             String        @id @default(cuid()) @map("id")
  sku_code       String        @unique @map("sku_code")
  product_id     String        @map("product_id")
  status         String        @default("ACTIVE") @map("status")
  created_at     DateTime      @default(now()) @map("created_at")
  updated_at     DateTime      @updatedAt @map("updated_at")

  product        Product       @relation(fields: [product_id], references: [id], onDelete: Cascade)
  price_lists    PriceListItem[]
  assets         Asset[]
  cart_items     CartItem[]
  wishlist_items WishlistItem[]
  order_lines    OrderLine[]

  @@map("skus")
}

// ============================================================================
// E-COMMERCE: SHOPPING CART
// ============================================================================

model ShoppingCart {
  id         String   @id @default(cuid()) @map("id")
  user_id    String?  @map("user_id") // null per guest users
  session_id String?  @map("session_id") // per identificare carrelli guest
  org_id     String?  @map("org_id") // organizzazione del buyer
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  user       User?        @relation(fields: [user_id], references: [id], onDelete: Cascade)
  org        Organization? @relation(fields: [org_id], references: [id], onDelete: Cascade)
  items      CartItem[]

  @@unique([user_id, org_id]) // un carrello per user/org
  @@unique([session_id]) // un carrello per sessione guest
  @@map("shopping_carts")
}

model CartItem {
  id               String   @id @default(cuid()) @map("id")
  cart_id          String   @map("cart_id")
  sku_id           String   @map("sku_id")
  quantity         Int      @default(1) @map("quantity")
  unit_price_cents Int?     @map("unit_price_cents") // prezzo al momento dell'aggiunta
  created_at       DateTime @default(now()) @map("created_at")

  cart             ShoppingCart @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  sku              Sku          @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@unique([cart_id, sku_id]) // un item per SKU per carrello
  @@map("cart_items")
}

// ============================================================================
// E-COMMERCE: WISHLIST (già esistente)
// ============================================================================

model WishlistItem {
  id           String   @id @default(cuid()) @map("id")
  buyer_org_id String   @map("buyer_org_id")
  sku_id       String   @map("sku_id")
  note         String?  @map("note")
  created_at   DateTime @default(now()) @map("created_at")

  buyer_org    Organization @relation(fields: [buyer_org_id], references: [id], onDelete: Cascade)
  sku          Sku          @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@unique([buyer_org_id, sku_id])
  @@map("wishlist_items")
}

// ============================================================================
// E-COMMERCE: ORDERS & PAYMENTS
// ============================================================================

model Order {
  id                    String      @id @default(cuid()) @map("id")
  order_number          String      @unique @map("order_number")
  buyer_org_id          String      @map("buyer_org_id")
  seller_org_id         String      @map("seller_org_id")

  status                OrderStatus @default(PENDING) @map("status")
  payment_status        PaymentStatus @default(UNPAID) @map("payment_status")

  // Totali
  subtotal_cents        Int         @map("subtotal_cents")
  tax_cents             Int         @default(0) @map("tax_cents")
  shipping_cents        Int         @default(0) @map("shipping_cents")
  discount_cents        Int         @default(0) @map("discount_cents")
  total_cents           Int         @map("total_cents")
  currency              String      @default("EUR") @map("currency")

  // Indirizzi
  shipping_address      Json        @map("shipping_address") // {name, company, address, city, province, postal_code, country, phone}
  billing_address       Json        @map("billing_address") // {name, company, address, city, province, postal_code, country, vat_number, tax_code}

  // Note e tracking
  customer_notes        String?     @map("customer_notes")
  internal_notes        String?     @map("internal_notes")
  tracking_number       String?     @map("tracking_number")
  shipped_at            DateTime?   @map("shipped_at")
  delivered_at          DateTime?   @map("delivered_at")

  created_at            DateTime    @default(now()) @map("created_at")
  updated_at            DateTime    @updatedAt @map("updated_at")

  buyer_org             Organization @relation("BuyerOrder", fields: [buyer_org_id], references: [id])
  seller_org            Organization @relation("SellerOrder", fields: [seller_org_id], references: [id])
  order_lines           OrderLine[]
  payments              Payment[]

  @@map("orders")
}

enum OrderStatus {
  PENDING     // In attesa di conferma
  CONFIRMED   // Confermato, in preparazione
  SHIPPED     // Spedito
  DELIVERED   // Consegnato
  CANCELLED   // Annullato
  REFUNDED    // Rimborsato
}

enum PaymentStatus {
  UNPAID      // Non pagato
  PENDING     // Pagamento in corso
  PAID        // Pagato
  FAILED      // Pagamento fallito
  REFUNDED    // Rimborsato
}

model OrderLine {
  id               String   @id @default(cuid()) @map("id")
  order_id         String   @map("order_id")
  sku_id           String   @map("sku_id")
  quantity         Int      @map("quantity")
  unit_price_cents Int      @map("unit_price_cents")
  line_total_cents Int      @map("line_total_cents")
  created_at       DateTime @default(now()) @map("created_at")

  order            Order    @relation(fields: [order_id], references: [id], onDelete: Cascade)
  sku              Sku      @relation(fields: [sku_id], references: [id])

  @@map("order_lines")
}

model Payment {
  id             String        @id @default(cuid()) @map("id")
  order_id       String        @map("order_id")
  amount_cents   Int           @map("amount_cents")
  currency       String        @default("EUR") @map("currency")
  payment_method String        @map("payment_method") // "stripe", "bank_transfer", etc.
  status         PaymentStatus @default(PENDING) @map("status")
  external_id    String?       @map("external_id") // ID Stripe, PayPal, etc.
  payment_data   Json?         @map("payment_data") // Dati aggiuntivi del pagamento
  paid_at        DateTime?     @map("paid_at")
  created_at     DateTime      @default(now()) @map("created_at")
  updated_at     DateTime      @updatedAt @map("updated_at")

  order          Order         @relation(fields: [order_id], references: [id])

  @@map("payments")
}

// ============================================================================
// ADDRESS MANAGEMENT
// ============================================================================

model Address {
  id             String      @id @default(cuid()) @map("id")
  org_id         String      @map("org_id")
  type           AddressType @map("type") // SHIPPING o BILLING
  name           String      @map("name") // Nome contatto
  company        String?     @map("company")
  address_line   String      @map("address_line")
  city           String      @map("city")
  province       String      @map("province")
  postal_code    String      @map("postal_code")
  country        String      @default("IT") @map("country")
  phone          String?     @map("phone")
  is_default     Boolean     @default(false) @map("is_default")
  created_at     DateTime    @default(now()) @map("created_at")
  updated_at     DateTime    @updatedAt @map("updated_at")

  org            Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@map("addresses")
}

enum AddressType {
  SHIPPING
  BILLING
}

// ============================================================================
// PLACEHOLDER MODELS (da completare)
// ============================================================================

model OrgPaymentAccount {
  id         String   @id @default(cuid()) @map("id")
  org_id     String   @unique @map("org_id")
  // Stripe customer ID, etc.
  created_at DateTime @default(now()) @map("created_at")

  org        Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@map("org_payment_accounts")
}

model PriceListItem {
  id            String   @id @default(cuid()) @map("id")
  price_list_id String   @map("price_list_id")
  sku_id        String   @map("sku_id")
  price_cents   Int      @map("price_cents")
  created_at    DateTime @default(now()) @map("created_at")

  sku           Sku      @relation(fields: [sku_id], references: [id])

  @@map("price_list_items")
}

model PriceList {
  id         String   @id @default(cuid()) @map("id")
  name       String   @map("name")
  status     String   @default("ACTIVE") @map("status")
  valid_from DateTime @map("valid_from")
  valid_to   DateTime? @map("valid_to")
  created_at DateTime @default(now()) @map("created_at")

  items      PriceListItem[]

  @@map("price_lists")
}

model Asset {
  id             String   @id @default(cuid()) @map("id")
  owning_org_id  String   @map("owning_org_id")
  managed_by_org_id String @map("managed_by_org_id")
  sku_id         String   @map("sku_id")
  serial_number  String?  @map("serial_number")
  asset_status   String   @map("asset_status")
  home_location_id String? @map("home_location_id")
  hours_total    Decimal? @map("hours_total")
  battery_cycles Int?     @map("battery_cycles")
  capabilities_json Json? @map("capabilities_json")
  notes         String?  @map("notes")
  productId     String?  @map("productId")

  sku           Sku      @relation(fields: [sku_id], references: [id])

  @@map("assets")
}

// Altri modelli placeholder per compatibilità
model OperatorProfile {
  id String @id @default(cuid())
  user_id String
  org_id String
  license_number String?
  certifications String[]
  experience_years Int?
  max_flight_time_hours Decimal?
  supported_drone_models String[]
  availability_schedule Json?
  preferred_regions String[]
  completed_missions Int @default(0)
  average_rating Decimal?
  reliability_score Decimal?
  is_active Boolean @default(true)
  last_active_at DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])
  org Organization @relation(fields: [org_id], references: [id])

  @@unique([user_id, org_id])
  @@map("operator_profiles")
}

model RateCard {
  id String @id @default(cuid())
  org_id String
  service_type String
  crop_type String?
  treatment_type String?
  terrain_conditions String?
  base_rate_per_ha_cents Int
  min_charge_cents Int
  travel_rate_per_km_cents Int?
  max_area_per_hour_ha Decimal?
  liquid_consumption_l_per_ha Decimal?
  is_active Boolean @default(true)
  valid_from DateTime @default(now())
  valid_to DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  org Organization @relation(fields: [org_id], references: [id])

  @@map("rate_cards")
}

model ServiceConfiguration {
  id String @id @default(cuid())
  org_id String @unique
  base_location_lat Decimal?
  base_location_lng Decimal?
  base_location_address String?
  working_hours_start Int
  working_hours_end Int
  available_days String
  offer_message_template String?
  rejection_message_template String?
  available_drones String[]
  preferred_terrain String?
  max_slope_percentage Int?
  fuel_surcharge_cents Int
  maintenance_surcharge_cents Int
  enable_offer_filters Boolean @default(true)
  max_distance_from_base Int?
  accepted_service_types String[]
  min_price_per_ha_cents Int?
  max_price_per_ha_cents Int?
  accepted_terrain_conditions String[]
  max_accepted_slope Int?
  enable_job_filters Boolean @default(true)
  operating_regions String?
  offered_service_types String?
  hourly_rate_min_cents Int?
  hourly_rate_max_cents Int?
  manageable_terrain String?
  max_manageable_slope Int?
  work_start_hour Int
  work_end_hour Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  org Organization @relation(fields: [org_id], references: [id])

  @@map("service_configurations")
}

model SavedField {
  id String @id @default(cuid())
  organization_id String
  name String
  polygon Json
  area_ha Decimal
  location_json Json?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  org Organization @relation(fields: [organization_id], references: [id])

  @@map("saved_fields")
}

model Job {
  id String @id @default(cuid())
  buyer_org_id String
  broker_org_id String?
  service_type String
  status String
  field_name String?
  field_polygon String
  area_ha Decimal
  location_json String?
  requested_window_start DateTime?
  requested_window_end DateTime?
  constraints_json String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  buyer_org Organization @relation("BuyerJob", fields: [buyer_org_id], references: [id])
  broker_org Organization? @relation("BrokerJob", fields: [broker_org_id], references: [id])
  offers JobOffer[]
  bookings Booking[]

  @@map("jobs")
}

model JobOffer {
  id String @id @default(cuid())
  job_id String
  operator_org_id String
  status String
  pricing_snapshot_json String
  total_cents Int
  currency String
  proposed_start DateTime?
  proposed_end DateTime?
  provider_note String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  job Job @relation(fields: [job_id], references: [id])
  operator_org Organization @relation("OperatorOffer", fields: [operator_org_id], references: [id])

  @@map("job_offers")
}

model Booking {
  id String @id @default(cuid())
  job_id String
  buyer_org_id String
  executor_org_id String
  broker_org_id String?
  service_type String
  status String
  payment_status String
  paid_at DateTime?
  actual_area_ha Decimal?
  actual_hours Decimal?
  notes String?
  executed_start_at DateTime?
  executed_end_at DateTime?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  job Job @relation(fields: [job_id], references: [id])
  buyer_org Organization @relation("BuyerBooking", fields: [buyer_org_id], references: [id])
  executor_org Organization @relation("ExecutorBooking", fields: [executor_org_id], references: [id])
  broker_org Organization? @relation("BrokerBooking", fields: [broker_org_id], references: [id])

  @@map("bookings")
}

model Message {
  id String @id @default(cuid())
  conversation_id String
  sender_user_id String
  sender_org_id String
  body String
  attachments_json String?
  created_at DateTime @default(now())

  conversation Conversation @relation(fields: [conversation_id], references: [id])
  sender User @relation(fields: [sender_user_id], references: [id])

  @@map("messages")
}

model Conversation {
  id String @id @default(cuid())
  context_type String
  context_id String
  status String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  messages Message[]
  participants ConversationParticipant[]

  @@map("conversations")
}

model ConversationParticipant {
  id String @id @default(cuid())
  conversation_id String
  org_id String
  role String
  created_at DateTime @default(now())

  conversation Conversation @relation(fields: [conversation_id], references: [id])
  org Organization @relation(fields: [org_id], references: [id])

  @@unique([conversation_id, org_id])
  @@map("conversation_participants")
}

model ExternalCalendarConnection {
  id String @id @default(cuid())
  user_id String
  provider String
  external_id String
  access_token String
  refresh_token String?
  expires_at DateTime?
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])

  @@unique([user_id, provider])
  @@map("external_calendar_connections")
}

model ExternalCalendar {
  id String @id @default(cuid())
  connection_id String
  external_id String
  name String
  color String?
  primary Boolean @default(false)
  created_at DateTime @default(now())

  @@map("external_calendars")
}

model ExternalCalendarEvent {
  id String @id @default(cuid())
  calendar_id String
  external_id String
  title String
  description String?
  start_time DateTime
  end_time DateTime
  location String?
  attendees String?
  created_at DateTime @default(now())

  @@map("external_calendar_events")
}

model VerificationCode {
  id String @id @default(cuid())
  user_id String?
  email String
  code String
  purpose String @default("EMAIL_VERIFICATION")
  expires_at DateTime
  used Boolean @default(false)
  used_at DateTime?
  created_at DateTime @default(now())

  user User? @relation(fields: [user_id], references: [id])

  @@map("verification_codes")
}

model OrganizationInvitation {
  id String @id @default(cuid())
  org_id String
  invited_by_user_id String
  email String
  role String
  status String @default("PENDING")
  token String @unique
  expires_at DateTime
  accepted_at DateTime?
  created_at DateTime @default(now())

  org Organization @relation(fields: [org_id], references: [id])
  invited_by User @relation(fields: [invited_by_user_id], references: [id])

  @@map("organization_invitations")
}

model UserNotificationPreferences {
  id String @id @default(cuid())
  user_id String @unique
  email_notifications Boolean @default(true)
  sms_notifications Boolean @default(false)
  push_notifications Boolean @default(true)
  job_updates Boolean @default(true)
  message_notifications Boolean @default(true)
  system_notifications Boolean @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id])

  @@map("user_notification_preferences")
}
