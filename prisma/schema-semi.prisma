// Schema semplificato per testing buyer registration
// SQLite compatible - no enums, no Json types

datasource db {
  provider = "sqlite"
  url = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
  output = "../generated/prisma"
}

// ============================================================================
// ESSENTIAL MODELS FOR BUYER REGISTRATION & AUTH
// ============================================================================

model User {
  id                  String   @id @default(cuid()) @map("id")
  email               String   @unique @map("email")
  phone               String?  @map("phone")
  first_name          String   @map("first_name")
  last_name           String   @map("last_name")
  password_salt       String?  @map("password_salt")
  password_hash       String?  @map("password_hash")
  email_verified      Boolean  @default(false) @map("email_verified")
  email_verified_at   DateTime? @map("email_verified_at")
  oauth_provider      String?  @map("oauth_provider")
  oauth_id            String?  @map("oauth_id")
  reset_token         String?  @map("reset_token")
  reset_token_expires DateTime? @map("reset_token_expires")
  status              String   @default("ACTIVE") @map("status")
  created_at          DateTime @default(now()) @map("created_at")
  updated_at          DateTime @updatedAt @map("updated_at")

  org_memberships               OrgMembership[]
  verification_codes            VerificationCode[]
  organization_invitations      OrganizationInvitation[]
  messages                      Message[]

  @@unique([oauth_provider, oauth_id])
  @@map("users")
}

model Organization {
  id            String   @id @default(cuid()) @map("id")
  legal_name    String   @map("legal_name")
  logo_url      String?  @map("logo_url")
  phone         String?  @map("phone")
  support_email String?  @map("support_email")
  vat_number    String?  @map("vat_number")
  tax_code      String?  @map("tax_code")
  kind          String   @default("BUSINESS") @map("kind")
  can_buy       Boolean  @default(true) @map("can_buy")
  can_sell      Boolean  @default(false) @map("can_sell")
  can_operate   Boolean  @default(false) @map("can_operate")
  can_dispatch  Boolean  @default(false) @map("can_dispatch")
  address_line  String   @map("address_line")
  city          String   @map("city")
  province      String   @map("province")
  region        String   @map("region")
  postal_code   String?  @map("postal_code")
  country       String   @default("IT") @map("country")
  status        String   @default("ACTIVE") @map("status")
  created_at    DateTime @default(now()) @map("created_at")

  org_memberships                OrgMembership[]
  organization_invitations       OrganizationInvitation[]
  org_payment_accounts           OrgPaymentAccount[]
  org_billing_profiles           OrgBillingProfile[]
  locations                      Location[]
  inventories                    Inventory[]
  assets_owned                   Asset[]                  @relation("AssetOwner")
  assets_managed                 Asset[]                  @relation("AssetManager")
  vendor_catalog_items           VendorCatalogItem[]
  price_lists                    PriceList[]
  offers                         Offer[]
  platform_fees                  PlatformFee[]
  rate_cards                     RateCard[]
  operator_profiles              OperatorProfile[]
  service_area_sets              ServiceAreaSet[]
  quote_requests_buyer           QuoteRequest[]           @relation("BuyerQuoteRequest")
  quotes_seller                  Quote[]                  @relation("SellerQuote")
  quotes_executor                Quote[]                  @relation("ExecutorQuote")
  orders_buyer                   Order[]                  @relation("BuyerOrder")
  orders_seller                  Order[]                  @relation("SellerOrder")
  bookings_buyer                 Booking[]                @relation("BuyerBooking")
  bookings_seller                Booking[]                @relation("SellerBooking")
  bookings_executor              Booking[]                @relation("ExecutorBooking")
  bookings_broker                Booking[]                @relation("BrokerBooking")
  payments_payer                 Payment[]                @relation("PayerPayment")
  payments_payee                 Payment[]                @relation("PayeePayment")
  service_sites                  ServiceSite[]
  jobs_buyer                     Job[]                    @relation("BuyerJob")
  jobs_broker                    Job[]                    @relation("BrokerJob")
  job_offers_operator            JobOffer[]               @relation("OperatorOffer")
  networks_source                ApprovedNetwork[]        @relation("NetworkSource")
  networks_target                ApprovedNetwork[]        @relation("NetworkTarget")
  job_invites_operator           JobInvite[]              @relation("InvitedOperator")
  conversation_participants      ConversationParticipant[]
  wishlist_items                 WishlistItem[]

  @@map("organizations")
}

model OrgMembership {
  id         String   @id @default(cuid()) @map("id")
  org_id     String   @map("org_id")
  user_id    String   @map("user_id")
  role       String   @default("BUYER") @map("role")
  is_active  Boolean  @default(true) @map("is_active")
  created_at DateTime @default(now()) @map("created_at")

  org Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)
  user User        @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([org_id, user_id])
  @@map("org_memberships")
}

// ============================================================================
// AUTHENTICATION
// ============================================================================

model VerificationCode {
  id         String   @id @default(cuid()) @map("id")
  user_id    String?  @map("user_id")
  email      String   @map("email")
  code       String   @map("code")
  purpose    String   @default("EMAIL_VERIFICATION") @map("purpose")
  expires_at DateTime @map("expires_at")
  used       Boolean  @default(false) @map("used")
  used_at    DateTime? @map("used_at")
  created_at DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([email, code, used])
  @@map("verification_codes")
}

model OrganizationInvitation {
  id                 String   @id @default(cuid()) @map("id")
  organization_id    String   @map("organization_id")
  email              String   @map("email")
  token              String   @unique @map("token")
  role               String   @default("BUYER") @map("role")
  invited_by_user_id String   @map("invited_by_user_id")
  expires_at         DateTime @map("expires_at")
  accepted_at        DateTime? @map("accepted_at")
  created_at         DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)
  invited_by   User         @relation(fields: [invited_by_user_id], references: [id], onDelete: Cascade)

  @@index([email, token])
  @@map("organization_invitations")
}

// ============================================================================
// JOB MARKETPLACE (MINIMAL VERSION)
// ============================================================================

model Job {
  id              String   @id @default(cuid()) @map("id")
  buyer_org_id    String   @map("buyer_org_id")
  broker_org_id   String?  @map("broker_org_id")
  service_type    String   @default("SPRAY") @map("service_type")
  status          String   @default("DRAFT") @map("status")
  field_name      String?  @map("field_name")
  field_polygon   String   @map("field_polygon")
  area_ha         Float?   @map("area_ha")
  location_json   String?  @map("location_json")
  requested_window_start DateTime? @map("requested_window_start")
  requested_window_end   DateTime? @map("requested_window_end")
  constraints_json       String?   @map("constraints_json")
  visibility_mode String  @default("WHITELIST_ONLY") @map("visibility_mode")
  accepted_offer_id String? @unique @map("accepted_offer_id")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  buyer_org Organization @relation("BuyerJob", fields: [buyer_org_id], references: [id], onDelete: Cascade)
  broker_org Organization? @relation("BrokerJob", fields: [broker_org_id], references: [id], onDelete: SetNull)
  offers     JobOffer[]
  booking Booking?
  invites JobInvite[]

  @@map("jobs")
}

model JobOffer {
  id             String @id @default(cuid()) @map("id")
  job_id         String @map("job_id")
  operator_org_id String @map("operator_org_id")
  status         String @default("SUBMITTED") @map("status")
  pricing_snapshot_json String @map("pricing_snapshot_json")
  total_cents     Int @map("total_cents")
  currency        String @default("EUR") @map("currency")
  proposed_start  DateTime? @map("proposed_start")
  proposed_end    DateTime? @map("proposed_end")
  reliability_snapshot_json String? @map("reliability_snapshot_json")
  offer_lines_json String? @map("offer_lines_json")
  provider_note     String? @map("provider_note")
  created_at DateTime @default(now()) @map("created_at")
  updated_at DateTime @updatedAt @map("updated_at")

  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)
  operator_org Organization @relation("OperatorOffer", fields: [operator_org_id], references: [id], onDelete: Cascade)

  @@index([job_id, status])
  @@map("job_offers")
}

model ApprovedNetwork {
  id               String @id @default(cuid()) @map("id")
  source_org_id    String @map("source_org_id")
  target_org_id    String @map("target_org_id")
  status           String @default("ACTIVE") @map("status")
  scope            String @default("SERVICES_ONLY") @map("scope")
  created_at DateTime @default(now()) @map("created_at")

  source_org Organization @relation("NetworkSource", fields: [source_org_id], references: [id], onDelete: Cascade)
  target_org Organization @relation("NetworkTarget", fields: [target_org_id], references: [id], onDelete: Cascade)

  @@unique([source_org_id, target_org_id])
  @@map("approved_networks")
}

model JobInvite {
  id              String @id @default(cuid()) @map("id")
  job_id          String @map("job_id")
  operator_org_id String @map("operator_org_id")
  status          String @default("PENDING") @map("status")
  invited_by      String @map("invited_by")
  created_at DateTime @default(now()) @map("created_at")

  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)
  operator_org Organization @relation("InvitedOperator", fields: [operator_org_id], references: [id], onDelete: Cascade)

  @@unique([job_id, operator_org_id])
  @@map("job_invites")
}

model Booking {
  id                 String   @id @default(cuid()) @map("id")
  job_id             String   @unique @map("job_id")
  buyer_org_id       String   @map("buyer_org_id")
  broker_org_id      String?  @map("broker_org_id")
  executor_org_id    String   @map("executor_org_id")
  service_type       String   @default("SPRAY") @map("service_type")
  service_site_id    String?  @map("service_site_id")
  site_snapshot_json String   @map("site_snapshot_json")
  status             String   @default("CONFIRMED") @map("status")
  created_at         DateTime @default(now()) @map("created_at")

  job Job @relation(fields: [job_id], references: [id], onDelete: Cascade)
  buyer_org Organization @relation("BuyerBooking", fields: [buyer_org_id], references: [id], onDelete: Cascade)
  broker_org Organization? @relation("BrokerBooking", fields: [broker_org_id], references: [id], onDelete: SetNull)
  executor_org Organization @relation("ExecutorBooking", fields: [executor_org_id], references: [id], onDelete: Cascade)
  service_site ServiceSite? @relation(fields: [service_site_id], references: [id], onDelete: SetNull)

  @@map("bookings")
}

// ============================================================================
// MESSAGING
// ============================================================================

model Conversation {
  id           String @id @default(cuid()) @map("id")
  context_type String @map("context_type")
  context_id   String @map("context_id")
  status       String @default("LOCKED") @map("status")
  unlocked_at  DateTime? @map("unlocked_at")
  created_at DateTime @default(now()) @map("created_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@unique([context_type, context_id])
  @@map("conversations")
}

model ConversationParticipant {
  id              String @id @default(cuid()) @map("id")
  conversation_id String @map("conversation_id")
  org_id          String @map("org_id")
  role            String @map("role")
  joined_at       DateTime @default(now()) @map("joined_at")

  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  org          Organization  @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@unique([conversation_id, org_id])
  @@map("conversation_participants")
}

model Message {
  id              String @id @default(cuid()) @map("id")
  conversation_id String @map("conversation_id")
  sender_user_id  String @map("sender_user_id")
  body            String @map("body")
  attachments_json String? @map("attachments_json")
  created_at DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [sender_user_id], references: [id], onDelete: Cascade)

  @@index([conversation_id, created_at])
  @@map("messages")
}

// ============================================================================
// MINIMAL PRODUCT SUPPORT FOR BUYER WISHLIST
// ============================================================================

model Product {
  id                     String   @id @default(cuid()) @map("id")
  product_type           String   @map("product_type")
  brand                  String   @map("brand")
  model                  String   @map("model")
  name                   String   @map("name")
  status                 String   @default("ACTIVE") @map("status")
  skus                   Sku[]

  @@map("products")
}

model Sku {
  id           String  @id @default(cuid()) @map("id")
  product_id   String  @map("product_id")
  sku_code     String  @unique @map("sku_code")
  variant_tags String? @map("variant_tags")
  uom          String  @default("unit") @map("uom")
  status       String  @default("ACTIVE") @map("status")

  product              Product             @relation(fields: [product_id], references: [id], onDelete: Cascade)
  vendor_catalog_items VendorCatalogItem[]
  order_lines          OrderLine[]
  wishlist_items       WishlistItem[]

  @@map("skus")
}

model VendorCatalogItem {
  id             String @id @default(cuid()) @map("id")
  vendor_org_id  String @map("vendor_org_id")
  sku_id         String @map("sku_id")
  is_for_sale    Boolean @default(true) @map("is_for_sale")
  is_for_rent    Boolean @default(false) @map("is_for_rent")
  lead_time_days Int?   @map("lead_time_days")
  notes          String? @map("notes")

  vendor_org Organization @relation(fields: [vendor_org_id], references: [id], onDelete: Cascade)
  sku        Sku         @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@unique([vendor_org_id, sku_id])
  @@map("vendor_catalog_items")
}

model WishlistItem {
  id          String @id @default(cuid()) @map("id")
  buyer_org_id String @map("buyer_org_id")
  sku_id      String @map("sku_id")
  note        String? @map("note")
  created_at DateTime @default(now()) @map("created_at")

  buyer_org Organization @relation(fields: [buyer_org_id], references: [id], onDelete: Cascade)
  sku       Sku          @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@unique([buyer_org_id, sku_id])
  @@map("wishlist_items")
}

// ============================================================================
// MINIMAL PLACEHOLDER MODELS
// ============================================================================

model Location {
  id           String   @id @default(cuid()) @map("id")
  org_id       String   @map("org_id")
  name         String   @map("name")
  address_json String   @map("address_json")
  lat          Float?   @map("lat")
  lon          Float?   @map("lon")
  is_hub       Boolean  @default(false) @map("is_hub")

  org               Organization      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  inventories       Inventory[]
  assets            Asset[]
  operator_profiles OperatorProfile[]

  @@map("locations")
}

model Inventory {
  id            String @id @default(cuid()) @map("id")
  vendor_org_id String @map("vendor_org_id")
  location_id   String @map("location_id")
  sku_id        String @map("sku_id")
  qty_on_hand   Int    @default(0) @map("qty_on_hand")
  qty_reserved  Int    @default(0) @map("qty_reserved")

  vendor_org Organization @relation(fields: [vendor_org_id], references: [id], onDelete: Cascade)
  location   Location     @relation(fields: [location_id], references: [id], onDelete: Cascade)
  sku        Sku          @relation(fields: [sku_id], references: [id], onDelete: Cascade)

  @@unique([vendor_org_id, location_id, sku_id])
  @@map("inventories")
}

model Asset {
  id                String   @id @default(cuid()) @map("id")
  owning_org_id     String   @map("owning_org_id")
  managed_by_org_id String   @map("managed_by_org_id")
  sku_id            String   @map("sku_id")
  serial_number     String?  @map("serial_number")
  asset_status      String   @default("AVAILABLE") @map("asset_status")
  home_location_id  String?  @map("home_location_id")
  hours_total       Float?   @map("hours_total")
  battery_cycles    Int?     @map("battery_cycles")
  capabilities_json String?  @map("capabilities_json")
  notes             String?  @map("notes")

  owning_org          Organization        @relation("AssetOwner", fields: [owning_org_id], references: [id], onDelete: Cascade)
  managed_by_org      Organization        @relation("AssetManager", fields: [managed_by_org_id], references: [id], onDelete: Cascade)
  sku                 Sku                 @relation(fields: [sku_id], references: [id], onDelete: Restrict)
  home_location       Location?           @relation(fields: [home_location_id], references: [id], onDelete: SetNull)

  @@map("assets")
}

model OperatorProfile {
  id                          String   @id @default(cuid()) @map("id")
  org_id                      String   @map("org_id")
  user_id                     String   @map("user_id")
  home_location_id            String?  @map("home_location_id")
  max_hours_per_day           Float?   @map("max_hours_per_day")
  max_ha_per_day              Float?   @map("max_ha_per_day")
  service_tags                String?  @map("service_tags")
  default_service_area_set_id String?  @map("default_service_area_set_id")
  service_area_mode           String   @default("ORG_DEFAULT") @map("service_area_mode")
  status                      String   @default("ACTIVE") @map("status")

  org                      Organization      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  user                     User              @relation(fields: [user_id], references: [id], onDelete: Cascade)
  home_location            Location?         @relation(fields: [home_location_id], references: [id], onDelete: SetNull)

  @@unique([org_id, user_id])
  @@map("operator_profiles")
}

model ServiceSite {
  id                String   @id @default(cuid()) @map("id")
  buyer_org_id      String   @map("buyer_org_id")
  name              String   @map("name")
  address           String   @map("address")
  lat               Float?   @map("lat")
  lon               Float?   @map("lon")
  municipality_code String?  @map("municipality_code")
  province_code     String?  @map("province_code")
  created_at        DateTime @default(now()) @map("created_at")

  buyer_org Organization @relation(fields: [buyer_org_id], references: [id], onDelete: Cascade)
  bookings  Booking[]

  @@map("service_sites")
}

// Minimal placeholder models
model OrgPaymentAccount {
  id                String   @id @default(cuid()) @map("id")
  org_id            String   @unique @map("org_id")
  provider          String   @default("stripe") @map("provider")
  stripe_account_id String?  @map("stripe_account_id")
  charges_enabled   Boolean  @default(false) @map("charges_enabled")
  payouts_enabled   Boolean  @default(false) @map("payouts_enabled")
  details_submitted Boolean  @default(false) @map("details_submitted")
  onboarding_status String   @default("PENDING") @map("onboarding_status")
  created_at        DateTime @default(now()) @map("created_at")
  updated_at        DateTime @updatedAt @map("updated_at")

  org Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@map("org_payment_accounts")
}

model OrgBillingProfile {
  id                   String   @id @default(cuid()) @map("id")
  org_id               String   @map("org_id")
  billing_name         String   @map("billing_name")
  vat_number           String?  @map("vat_number")
  tax_code             String?  @map("tax_code")
  billing_address_json String   @map("billing_address_json")
  sdi_code             String?  @map("sdi_code")
  pec_email            String?  @map("pec_email")
  invoice_email        String   @map("invoice_email")
  created_at           DateTime @default(now()) @map("created_at")

  org Organization @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@map("org_billing_profiles")
}

model PriceList {
  id            String   @id @default(cuid()) @map("id")
  vendor_org_id String   @map("vendor_org_id")
  name          String   @map("name")
  currency      String   @default("EUR") @map("currency")
  valid_from    DateTime @map("valid_from")
  valid_to      DateTime? @map("valid_to")
  status        String   @default("ACTIVE") @map("status")

  vendor_org Organization    @relation(fields: [vendor_org_id], references: [id], onDelete: Cascade)

  @@map("price_lists")
}

model Offer {
  id            String   @id @default(cuid()) @map("id")
  vendor_org_id String   @map("vendor_org_id")
  offer_type    String   @map("offer_type")
  name          String   @map("name")
  rules_json    String   @map("rules_json")
  valid_from    DateTime @map("valid_from")
  valid_to      DateTime? @map("valid_to")
  status        String   @default("ACTIVE") @map("status")

  vendor_org Organization @relation(fields: [vendor_org_id], references: [id], onDelete: Cascade)

  @@map("offers")
}

model PlatformFee {
  id              String   @id @default(cuid()) @map("id")
  vendor_org_id   String   @map("vendor_org_id")
  fee_type        String   @map("fee_type")
  fee_percent     Float?   @map("fee_percent")
  fee_fixed_cents Int?     @map("fee_fixed_cents")
  applies_to      String   @map("applies_to")
  valid_from      DateTime @map("valid_from")
  valid_to        DateTime? @map("valid_to")
  created_at      DateTime @default(now()) @map("created_at")

  vendor_org Organization @relation(fields: [vendor_org_id], references: [id], onDelete: Cascade)

  @@map("platform_fees")
}

model RateCard {
  id                         String   @id @default(cuid()) @map("id")
  seller_org_id              String   @map("seller_org_id")
  service_type               String   @map("service_type")
  base_rate_per_ha_cents     Int      @map("base_rate_per_ha_cents")
  min_charge_cents           Int      @map("min_charge_cents")
  travel_rate_per_km_cents   Int      @map("travel_rate_per_km_cents")
  hourly_operator_rate_cents Int?     @map("hourly_operator_rate_cents")
  seasonal_multipliers_json  String?  @map("seasonal_multipliers_json")
  risk_multipliers_json      String?  @map("risk_multipliers_json")
  show_company_only          Boolean  @default(false) @map("show_company_only")
  assigned_operator_ids      String?  @map("assigned_operator_ids")
  supported_model_codes      String?  @map("supported_model_codes")
  operator_assignment_mode   String   @map("operator_assignment_mode")
  service_area_set_id        String?  @map("service_area_set_id")
  crop_types                 String?  @map("crop_types")

  seller_org Organization @relation(fields: [seller_org_id], references: [id], onDelete: Cascade)

  @@unique([seller_org_id, service_type])
  @@map("rate_cards")
}

model ServiceAreaSet {
  id         String   @id @default(cuid()) @map("id")
  owner_type String   @map("owner_type")
  owner_id   String   @map("owner_id")
  name       String   @map("name")
  is_default Boolean  @default(false) @map("is_default")
  created_at DateTime @default(now()) @map("created_at")

  items              ServiceAreaSetItem[]
  operator_profiles  OperatorProfile[]
  organization       Organization?        @relation(fields: [organizationId], references: [id])
  organizationId     String?

  @@map("service_area_sets")
}

model ServiceAreaSetItem {
  id                  String @id @default(cuid()) @map("id")
  service_area_set_id String @map("service_area_set_id")
  geo_admin_unit_id   String @map("geo_admin_unit_id")
  include_mode        String @default("INCLUDE") @map("include_mode")
  created_at          DateTime @default(now()) @map("created_at")

  service_area_set ServiceAreaSet @relation(fields: [service_area_set_id], references: [id], onDelete: Cascade)

  @@unique([service_area_set_id, geo_admin_unit_id])
  @@map("service_area_set_items")
}

model QuoteRequest {
  id                  String   @id @default(cuid()) @map("id")
  buyer_org_id        String   @map("buyer_org_id")
  request_type        String   @map("request_type")
  service_params_json String   @map("service_params_json")
  status              String   @default("OPEN") @map("status")
  created_at          DateTime @default(now()) @map("created_at")

  buyer_org Organization @relation("BuyerQuoteRequest", fields: [buyer_org_id], references: [id], onDelete: Cascade)
  quotes    Quote[]

  @@map("quote_requests")
}

model Quote {
  id                    String   @id @default(cuid()) @map("id")
  quote_request_id      String   @map("quote_request_id")
  seller_org_id         String   @map("seller_org_id")
  executor_org_id       String   @map("executor_org_id")
  revision              Int      @default(1) @map("revision")
  pricing_snapshot_json String   @map("pricing_snapshot_json")
  total_estimated_cents Int      @map("total_estimated_cents")
  currency              String   @default("EUR") @map("currency")
  valid_until           DateTime @map("valid_until")
  status                String   @default("DRAFT") @map("status")

  quote_request QuoteRequest @relation(fields: [quote_request_id], references: [id], onDelete: Cascade)
  seller_org    Organization @relation("SellerQuote", fields: [seller_org_id], references: [id], onDelete: Cascade)
  executor_org  Organization @relation("ExecutorQuote", fields: [executor_org_id], references: [id], onDelete: Cascade)

  @@map("quotes")
}

model Order {
  id            String   @id @default(cuid()) @map("id")
  buyer_org_id  String   @map("buyer_org_id")
  seller_org_id String   @map("seller_org_id")
  quote_id      String?  @map("quote_id")
  order_status  String   @default("PAID") @map("order_status")
  total_cents   Int      @map("total_cents")
  currency      String   @default("EUR") @map("currency")
  created_at    DateTime @default(now()) @map("created_at")

  buyer_org   Organization @relation("BuyerOrder", fields: [buyer_org_id], references: [id], onDelete: Cascade)
  seller_org  Organization @relation("SellerOrder", fields: [seller_org_id], references: [id], onDelete: Cascade)
  order_lines OrderLine[]

  @@map("orders")
}

model OrderLine {
  id                        String @id @default(cuid()) @map("id")
  order_id                  String @map("order_id")
  sku_id                    String @map("sku_id")
  qty                       Int    @map("qty")
  unit_price_snapshot_cents Int    @map("unit_price_snapshot_cents")
  line_total_cents          Int    @map("line_total_cents")

  order Order @relation(fields: [order_id], references: [id], onDelete: Cascade)
  sku   Sku   @relation(fields: [sku_id], references: [id], onDelete: Restrict)

  @@map("order_lines")
}

model Payment {
  id                       String   @id @default(cuid()) @map("id")
  payer_org_id             String   @map("payer_org_id")
  payee_org_id             String   @map("payee_org_id")
  related_type             String   @map("related_type")
  related_id               String   @map("related_id")
  payment_purpose          String   @map("payment_purpose")
  amount_authorized_cents  Int?     @map("amount_authorized_cents")
  amount_captured_cents    Int?     @map("amount_captured_cents")
  currency                 String   @default("EUR") @map("currency")
  stripe_payment_intent_id String?  @map("stripe_payment_intent_id")
  stripe_charge_id         String?  @map("stripe_charge_id")
  stripe_account_id        String?  @map("stripe_account_id")
  application_fee_cents    Int?     @map("application_fee_cents")
  payment_status           String   @default("REQUIRES_PAYMENT") @map("payment_status")
  created_at               DateTime @default(now()) @map("created_at")
  captured_at              DateTime? @map("captured_at")

  payer_org Organization @relation("PayerPayment", fields: [payer_org_id], references: [id], onDelete: Cascade)
  payee_org Organization @relation("PayeePayment", fields: [payee_org_id], references: [id], onDelete: Cascade)

  @@map("payments")
}

model UserNotificationPreferences {
  id                String   @id @default(cuid()) @map("id")
  user_id           String   @unique @map("user_id")
  email_orders      Boolean  @default(true) @map("email_orders")
  email_payments    Boolean  @default(true) @map("email_payments")
  email_updates     Boolean  @default(false) @map("email_updates")
  inapp_orders      Boolean  @default(true) @map("inapp_orders")
  inapp_messages    Boolean  @default(true) @map("inapp_messages")
  created_at        DateTime @default(now()) @map("created_at")
  updated_at        DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_notification_preferences")
}
