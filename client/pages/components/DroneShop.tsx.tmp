const DroneShop = () => {
  const [selectedDrone, setSelectedDrone] = useState<Drone | null>(null);
  const [roiData, setRoiData] = useState<ReturnType<typeof calculateROI> | null>(null);
  const [hectaresInput, setHectaresInput] = useState(500);
  const [selectedCrop, setSelectedCrop] = useState<Crop | null>(null);
  const [selectedTreatment, setSelectedTreatment] = useState<Treatment | null>(null);
  const [interventionsPerYear, setInterventionsPerYear] = useState(1);
  const [isHilly, setIsHilly] = useState(false);

  // Fetch data from API
  const { data: drones = [], isLoading: dronesLoading } = useQuery({
    queryKey: ['drones'],
    queryFn: fetchDrones
  });

  const { data: crops = [], isLoading: cropsLoading } = useQuery({
    queryKey: ['crops'],
    queryFn: fetchCrops
  });

  const { data: treatments = [], isLoading: treatmentsLoading } = useQuery({
    queryKey: ['treatments'],
    queryFn: fetchTreatments
  });

  // Set default crop and treatment when data loads
  useEffect(() => {
    if (crops.length > 0 && !selectedCrop) {
      setSelectedCrop(crops[0]);
    }
  }, [crops, selectedCrop]);

  useEffect(() => {
    if (treatments.length > 0 && !selectedTreatment) {
      setSelectedTreatment(treatments[0]);
    }
  }, [treatments, selectedTreatment]);

  const openROI = (drone: Drone) => {
    setSelectedDrone(drone);
    setRoiData(calculateROI(drone, hectaresInput, selectedCrop, selectedTreatment, interventionsPerYear, isHilly));
  };

  const recalculateROI = () => {
    if (selectedDrone) {
      setRoiData(calculateROI(selectedDrone, hectaresInput, selectedCrop, selectedTreatment, interventionsPerYear, isHilly));
    }
  };

  const updateROI = (hectares: number) => {
    setHectaresInput(hectares);
    if (selectedDrone) {
      setRoiData(calculateROI(selectedDrone, hectares, selectedCrop, selectedTreatment, interventionsPerYear, isHilly));
    }
  };

  return (
    <div className="max-w-6xl mx-auto">
      <h2 className="text-3xl font-bold text-slate-900 mb-2">Catalogo Droni Agricoli DJI</h2>
      <p className="text-slate-500 mb-8">Prezzi IVA esclusa, kit completo con batterie e accessori. Supporto tecnico certificato incluso.</p>

      {dronesLoading ? (
        <div className="text-center py-12 text-slate-500">Caricamento droni...</div>
      ) : (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {drones.map(drone => (
          <div key={drone.id} className="bg-white rounded-lg border border-slate-200 overflow-hidden hover:shadow-2xl hover:-translate-y-1 hover:border-emerald-400 transition-all group relative">

            <div className="h-56 bg-white flex items-center justify-center relative overflow-hidden">
                {/* Mostra GLB come prima immagine se disponibile */}
                {(drone as any).glbUrl ? (
                  <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-slate-50 to-slate-100 relative">
                    {/* @ts-ignore - model-viewer √® un web component */}
                    <model-viewer
                      src={(drone as any).glbUrl}
                      alt={`Modello 3D ${drone.model}`}
                      auto-rotate
                      camera-controls
                      interaction-policy="allow-when-focused"
                      style={{ width: '100%', height: '100%', minHeight: '224px' }}
                      className="object-contain"
                      loading="eager"
                    />
                    {/* Fallback immagine nascosta - mostrata se GLB fallisce */}
                    {drone.imageUrl && (
                      <img
                        src={drone.imageUrl}
                        alt={`Drone agricolo ${drone.model}`}
                        className="h-52 w-auto object-contain drop-shadow-2xl absolute inset-0 m-auto opacity-0 pointer-events-none"
                        style={{ zIndex: -1 }}
                      />
                    )}
                  </div>
                ) : drone.imageUrl ? (
                <img
                  src={drone.imageUrl}
                  alt={`Drone agricolo ${drone.model}`}
                  className="h-52 w-auto object-contain drop-shadow-2xl transition-transform duration-300 group-hover:scale-110"
                />
              ) : (
                <Plane size={100} className="text-slate-300 group-hover:scale-110 transition duration-300" />
              )}
            </div>
            <div className="p-5">
              <div className="mb-3">
                <h3 className="font-bold text-base text-slate-900 uppercase tracking-wide">{drone.model}</h3>
                <p className="text-xs text-slate-500 font-medium mb-1">{drone.category}</p>
                <div className="flex items-center gap-1.5 text-xs text-emerald-600">
                  <span className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
                  <span className="font-semibold">Disponibile</span>
                </div>
              </div>
              <p className="text-xs text-slate-600 mb-4 min-h-[2rem]">{drone.tagline}</p>

              {/* Specs with Icons - No Gray Background */}
              <div className="mb-4 py-3 border-t border-b border-slate-200">
                <div className="flex items-center justify-between text-xs mb-2">
                  <div className="flex items-center gap-1.5 text-slate-500">
                    <Droplet size={14} className="text-slate-400" />
                    <span>Serbatoio</span>
                  </div>
                  <strong className="text-slate-900 text-sm">{drone.tankCapacity?.split(' ')[0] || 'N/A'}</strong>
                </div>
                <div className="flex items-center justify-between text-xs">
                  <div className="flex items-center gap-1.5 text-slate-500">
                    <Wind size={14} className="text-slate-400" />
                    <span>Efficienza</span>
                  </div>
                  <strong className="text-slate-900 text-sm">{drone.efficiency || 'N/A'}</strong>
                </div>
              </div>

              {/* Tech Highlight */}
              <div className="text-[10px] text-center text-slate-600 font-medium mb-4 px-1 leading-tight min-h-[2.5rem]">
                {drone.features || drone.tagline}
              </div>

              {/* Price - Bigger and Black */}
              <div className="mb-4">
                 <p className="text-3xl font-bold text-black">‚Ç¨ {drone.price.toLocaleString()}</p>
              </div>

              {/* Buttons */}
              <div className="space-y-2">
                <Link
                  to={`/drones/${drone.id}`}
                  className="block w-full bg-emerald-600 text-white py-2.5 rounded-lg font-semibold text-sm hover:bg-emerald-700 transition-all text-center uppercase tracking-wide"
                >
                  Dettagli ‚Üí
                </Link>
              <Button
                onClick={() => openROI(drone)}
                variant="outline"
                className="w-full text-sm py-2.5 border-2 border-emerald-600 text-emerald-700 hover:bg-emerald-600 hover:text-white font-semibold uppercase tracking-wide transition-all"
              >
                <Calculator size={14}/> Calcola ROI
              </Button>
              </div>
            </div>
          </div>
        ))}
      </div>
      )}

      {selectedDrone && roiData && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 overflow-y-auto">
          <div className="bg-white rounded-2xl max-w-4xl w-full p-8 relative my-8">
            <button onClick={() => setSelectedDrone(null)} className="absolute top-4 right-4 p-2 hover:bg-slate-100 rounded-full"><X size={20}/></button>
            
            <div className="flex items-center gap-3 mb-6">
              <Calculator className="text-emerald-600" size={28} />
              <div>
                <h3 className="text-2xl font-bold">Simulatore ROI: {selectedDrone.model}</h3>
                <p className="text-sm text-slate-500">Ritorno sull'Investimento Personalizzato</p>
              </div>
            </div>

            {/* 3-Step Configuration */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              {/* Step 1: Coltura */}
              <div className="bg-slate-50 p-4 rounded-xl">
                <label className="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                  Step 1: Coltura
                </label>
                <select
                  value={selectedCrop.id}
                  onChange={(e) => {
                    const crop = crops.find(c => c.id === e.target.value) || crops[0];
                    setSelectedCrop(crop);
                    recalculateROI();
                  }}
                  className="w-full p-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  {crops.map(crop => (
                    <option key={crop.id} value={crop.id}>{crop.name}</option>
                  ))}
                </select>
                <p className="text-xs text-slate-500 mt-2">Ricavo: <strong>‚Ç¨ {selectedCrop.grossRevenue.toLocaleString()}/ha</strong></p>
              </div>

              {/* Step 2: Trattamento */}
              <div className="bg-slate-50 p-4 rounded-xl">
                <label className="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                  Step 2: Trattamento
                </label>
                <select
                  value={selectedTreatment.id}
                  onChange={(e) => {
                    const treatment = treatments.find(t => t.id === e.target.value) || treatments[0];
                    setSelectedTreatment(treatment);
                    recalculateROI();
                  }}
                  className="w-full p-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  {treatments.map(treatment => (
                    <option key={treatment.id} value={treatment.id}>{treatment.name}</option>
                  ))}
                </select>
                <p className="text-xs text-slate-500 mt-2">
                  {selectedTreatment.type === 'liquid' ? 'üíß' : 'üì¶'} {selectedTreatment.dosage} ‚Ä¢ {selectedTreatment.operatingSpeed} ha/h
                </p>
              </div>

              {/* Step 3: Interventi */}
              <div className="bg-slate-50 p-4 rounded-xl">
                <label className="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                  Step 3: Interventi/Anno
                </label>
                <select
                  value={interventionsPerYear}
                  onChange={(e) => {
                    setInterventionsPerYear(parseInt(e.target.value));
                    recalculateROI();
                  }}
                  className="w-full p-2 border border-slate-300 rounded-lg text-sm font-medium text-slate-800 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                >
                  {[1, 2, 3, 4, 5, 6].map(num => (
                    <option key={num} value={num}>{num} volt{num > 1 ? 'e' : 'a'}</option>
                  ))}
                </select>
                <p className="text-xs text-slate-500 mt-2">Ore volo: <strong>{roiData.operatingHoursPerYear.toFixed(1)}h/anno</strong></p>
              </div>
            </div>

            {/* Terrain Toggle */}
            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-6 flex items-center justify-between">
              <div className="flex items-center gap-3">
                <span className="text-2xl">‚õ∞Ô∏è</span>
                <div>
                  <p className="text-sm font-bold text-slate-800">Terreno Collinare / Complesso</p>
                  <p className="text-xs text-slate-600">+40% prezzo terzista, -30% velocit√† operativa</p>
                </div>
              </div>
              <button
                onClick={() => {
                  setIsHilly(!isHilly);
                  recalculateROI();
                }}
                className={`relative inline-flex h-6 w-11 items-center rounded-full transition ${
                  isHilly ? 'bg-emerald-600' : 'bg-slate-300'
                }`}
              >
                <span
                  className={`inline-block h-4 w-4 transform rounded-full bg-white transition ${
                    isHilly ? 'translate-x-6' : 'translate-x-1'
                  }`}
                />
              </button>
            </div>

            <div className="bg-slate-50 p-4 rounded-xl mb-6">
              <label className="block text-sm font-bold text-slate-700 mb-2">
                Ettari da Trattare Annualmente
              </label>
              <input
                type="range"
                min="100"
                max="1000"
                step="50"
                value={hectaresInput}
                onChange={(e) => updateROI(parseInt(e.target.value))}
                className="w-full h-2 bg-slate-300 rounded-lg appearance-none cursor-pointer accent-emerald-600"
                style={{
                  background: `linear-gradient(to right, #10b981 0%, #10b981 ${((hectaresInput - 100) / 900) * 100}%, #cbd5e1 ${((hectaresInput - 100) / 900) * 100}%, #cbd5e1 100%)`
                }}
              />
              <div className="flex justify-between text-xs text-slate-500 mt-1">
                <span>100 ha</span>
                <span className="font-bold text-emerald-700 text-lg">{hectaresInput} ha/anno</span>
                <span>1000 ha</span>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div className="space-y-4">
                <h4 className="font-bold text-slate-800 flex items-center gap-2">
                  <DollarSign size={18} className="text-emerald-600"/> Investimento
                </h4>
                <div className="bg-slate-100 p-4 rounded-lg">
                  <p className="text-sm text-slate-600">Costo Acquisto (Kit Completo)</p>
                  <p className="text-3xl font-bold text-slate-900">‚Ç¨ {selectedDrone.price.toLocaleString()}</p>
                </div>

                <h4 className="font-bold text-slate-800 flex items-center gap-2 mt-6">
                  <TrendingUp size={18} className="text-blue-600"/> Analisi Economica
                </h4>
                <div className="space-y-0 text-sm">
                  <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                    <span className="text-slate-600">Costo Terzista Esterno</span>
                    <strong className="text-red-600 font-mono">-‚Ç¨ {roiData.externalServiceCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                  </div>
                  <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                    <span className="text-slate-600">Costo Operativo Drone</span>
                    <strong className="text-emerald-600 font-mono">+‚Ç¨ {roiData.droneOperatingCost.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                  </div>
                  <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                    <span className="text-slate-600">Risparmio Servizio</span>
                    <strong className="text-slate-900 font-mono">‚Ç¨ {roiData.serviceSavings.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                  </div>
                  {selectedCrop.tramplingEnabled && roiData.croppingDamageSaved > 0 && (
                    <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                      <span className="text-slate-600">Zero Calpestamento ({(selectedCrop.tramplingImpact * 100).toFixed(1)}%)</span>
                      <strong className="text-slate-900 font-mono">‚Ç¨ {roiData.croppingDamageSaved.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                    </div>
                  )}
                  {selectedTreatment.type === 'liquid' && (
                    <>
                      <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                        <span className="text-slate-600">Fitofarmaci (-18%)</span>
                        <strong className="text-slate-900 font-mono">‚Ç¨ {roiData.chemicalSavings.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                      </div>
                      <div className="flex justify-between py-3 border-b border-dashed border-slate-200">
                        <span className="text-slate-600 flex items-center gap-1"><Droplet size={14}/> Acqua (-90%)</span>
                        <strong className="text-slate-900 font-mono">‚Ç¨ {roiData.waterSavings.toLocaleString(undefined, {maximumFractionDigits: 0})}</strong>
                      </div>
                    </>
                  )}
                  <div className="flex justify-between p-3 bg-slate-900 text-white rounded font-bold mt-3">
                    <span>Totale Risparmi Annui</span>
                    <span className="font-mono">‚Ç¨ {roiData.totalAnnualSavings.toLocaleString(undefined, {maximumFractionDigits: 0})}</span>
                  </div>
                </div>
              </div>

              <div className="bg-[#141414] text-white p-8 rounded-xl flex flex-col justify-between shadow-2xl">
                <div>
                   <p className="text-emerald-500 text-xs uppercase font-bold tracking-widest mb-3 letterspacing-2">Break Even Point</p>
                   <p className="text-7xl font-extrabold mb-2 leading-none text-white">{roiData.breakEvenMonths}</p>
                   <p className="text-2xl font-bold mb-1 text-white">Mesi</p>
                   <p className="text-sm text-slate-400">Basato su {hectaresInput} ha/anno</p>

                   <div className="mt-6 p-4 bg-[#222] rounded-lg border-l-4 border-emerald-500">
                     <p className="text-xs text-slate-400 uppercase font-bold mb-2">Profitto Primo Anno</p>
                     <p className="text-3xl font-bold font-mono text-emerald-500">
                       {roiData.firstYearProfit > 0 ? '+' : ''}‚Ç¨ {roiData.firstYearProfit.toLocaleString(undefined, {maximumFractionDigits: 0})}
                     </p>
                   </div>

                   <div className="mt-4 p-4 bg-[#222] rounded-lg border-l-4 border-emerald-500">
                     <p className="text-xs text-slate-400 uppercase font-bold mb-2">Ricavi Conto Terzi Potenziali</p>
                     <p className="text-3xl font-bold font-mono text-emerald-500">‚Ç¨ {roiData.potentialServiceRevenue.toLocaleString(undefined, {maximumFractionDigits: 0})}<span className="text-lg text-slate-400">/anno</span></p>
                     <p className="text-xs text-slate-500 mt-1">Basato su {selectedTreatment.name}</p>
                   </div>
                </div>

                <Button className="w-full mt-6 bg-emerald-600 text-white hover:bg-emerald-500 shadow-lg font-bold uppercase tracking-wide">
                  <CheckCircle size={16}/> Richiedi Preventivo
                </Button>
              </div>
            </div>

            <div className="bg-slate-50 border border-slate-200 rounded-lg p-4 flex items-start gap-3">
              <span className="text-slate-400 text-lg">‚ÑπÔ∏è</span>
              <p className="text-xs text-slate-600 leading-relaxed">
                <strong className="text-slate-700">Metodologia Scientifica:</strong> Calcoli basati su dati Italia Nord/Centro 2024-2025.
                Coltura: {selectedCrop.name} (‚Ç¨{selectedCrop.grossRevenue.toLocaleString()}/ha).
                Trattamento: {selectedTreatment.name} ({selectedTreatment.operatingSpeed} ha/h).
                {selectedCrop.tramplingEnabled ? `Calpestamento: ${(selectedCrop.tramplingImpact * 100).toFixed(1)}%. ` : ''}
                {isHilly ? 'Terreno collinare: +40% costo terzista, -30% velocit√†. ' : ''}
                Costo operativo drone: ‚Ç¨2.50/ha (energia + usura).
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};
